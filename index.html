<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Paws - Accessible Study Assistant</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --brand: #1c64f2;
      --ok: #f04b82; /* Using the pink from the first file for 'ok' actions */
      --warn: #92400e;
      --pink: #de79fd; /* Main brand pink from the first file */
      --light-pink: #fde6ff; /* Light pink from the first file */
      --error: #991b1b;
      --radius: 14px;
      --line: 1.9;
      --font-size-base: 16px;
      --spacing-base: 1;
    }
    @media (prefers-color-scheme: dark) {
      :root { 
        --bg:#0f1115; 
        --fg:#f5f7fb; 
        --muted:#a5adbd; 
        --brand:#5b8aff; /* Updated brand for dark mode from second file */
        --pink:#5b8aff; /* Using updated brand for pink in dark mode */
        --light-pink: #2a2c3a; 
      }
    }
    
    /* Accessibility Mode Adjustments (Combined and enhanced) */
    body.reading-support {
      --font-size-base: 18px;
      --line: 2.2;
      font-family: 'Comic Sans MS', 'OpenDyslexic', Arial, sans-serif;
    }
    
    body.vision-support {
      --font-size-base: 20px;
      --line: 2.4;
      --fg: #000000;
      --bg: #ffffff;
    }
    
    body.focus-support {
      --spacing-base: 1.3;
      counter-reset: section; /* From second file */
    }
    
    html, body { height: 100%; }
    body {
      margin: 0; 
      background: var(--bg); 
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      line-height: var(--line);
      font-size: var(--font-size-base);
      transition: font-size 0.3s ease, line-height 0.3s ease, background 0.3s ease, color 0.3s ease;
    }
    
    .wrap { 
      max-width: 1100px; 
      margin: 0 auto; 
      padding: calc(28px * var(--spacing-base)); 
    }
    
    h1 { 
      font-size: clamp(1.6rem, 2.2vw + 1rem, 3rem); 
      font-weight: 600; 
      margin: 0; /* Adjusted from second file to fit mascot layout */
    }
    h2 { 
      margin-top: calc(32px * var(--spacing-base)); 
      font-weight: 600; 
    }
    p { margin: calc(8px * var(--spacing-base)) 0; }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    /* Focus Support: Highlight interactive elements */
    body.focus-support h2::before {
      content: "Step " counter(section) ": ";
      counter-increment: section;
      color: var(--brand);
      font-weight: 700;
    }
    
    body.focus-support button,
    body.focus-support input[type="file"]::file-selector-button,
    body.focus-support select {
      box-shadow: 0 0 0 3px rgba(28, 100, 242, 0.2);
      transition: all 0.2s ease;
    }
    
    body.focus-support button:hover,
    body.focus-support input[type="file"]::file-selector-button:hover {
      box-shadow: 0 0 0 4px rgba(28, 100, 242, 0.4);
      transform: scale(1.05);
    }
    
    textarea {
      box-sizing: border-box; 
      width: 100%; 
      resize: vertical; 
      min-height: calc(140px * var(--spacing-base));
      padding: calc(12px * var(--spacing-base)); 
      margin: calc(16px * var(--spacing-base)) 0 0 0; 
      border: 2px solid var(--muted); 
      border-radius: var(--radius);
      background: var(--bg); 
      color: var(--fg); 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      font-size: 1.05rem;
      line-height: var(--line);
    }
    
    /* Vision Support: High contrast borders */
    body.vision-support textarea,
    body.vision-support button,
    body.vision-support select,
    body.vision-support input,
    body.vision-support .profile-option, /* Added from first file */
    body.vision-support #output, /* Added from first file */
    body.vision-support .response-customization { /* Added from first file */
      border: 3px solid #000000 !important;
      font-weight: 600;
    }
    
    /* Writing Support: Larger text input and word counter */
    body.writing-support textarea {
      min-height: 200px;
      font-size: 1.2rem;
    }
    
    button, input[type="file"]::file-selector-button {
      background: var(--pink); /* Changed to use --pink from first file */
      color: white; 
      border: none; 
      cursor: pointer;
      padding: calc(10px * var(--spacing-base)) calc(16px * var(--spacing-base)); 
      margin: calc(8px * var(--spacing-base)) calc(8px * var(--spacing-base)) calc(8px * var(--spacing-base)) 0; 
      border-radius: var(--radius);
      font-size: 1rem; 
      font-weight: 600; 
      transition: background 0.2s;
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px;
    }
    button:hover, input[type="file"]::file-selector-button:hover { 
      background: color-mix(in srgb, var(--pink) 90%, black); /* Adjusted to use --pink */
    }
    
    button:focus, select:focus, textarea:focus, input:focus {
      outline: 3px solid var(--brand);
      outline-offset: 2px;
    }
    
    .muted { 
      color: var(--muted); 
      font-size: 0.95rem; 
    }

    .file-input-container { 
      display:flex; 
      align-items:center; 
      gap: calc(16px * var(--spacing-base)); 
      margin-bottom: calc(16px * var(--spacing-base)); 
      flex-wrap: wrap; 
    }
    #file-display { 
      font-size: 0.9em; 
      color: var(--muted); 
      max-width: 420px; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap; 
    }

    .profile-selection-container { 
      margin-top: calc(16px * var(--spacing-base)); 
      border: 2px solid var(--muted); 
      border-radius: var(--radius); 
      padding: calc(16px * var(--spacing-base)); 
      background: color-mix(in srgb, var(--bg) 95%, var(--muted)); 
    }
    .profile-selection-container h3 { 
      margin:0 0 calc(8px * var(--spacing-base)) 0; 
      font-size:1.15rem; 
      font-weight:600; 
    }

    .profile-options { 
      display:grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: calc(12px * var(--spacing-base)); 
    }
    .profile-option { 
      display:flex; 
      align-items:center; 
      gap:10px; 
      cursor:pointer; 
      padding: calc(12px * var(--spacing-base)); 
      border:2px solid var(--muted); 
      border-radius: var(--radius); 
      background:#fff; 
      transition: background 0.2s, border-color 0.2s, transform 0.2s; 
    }
    .profile-option:hover { 
      background: color-mix(in srgb, var(--bg) 92%, var(--pink)); /* Adjusted to use --pink */
      border-color: var(--pink); /* Adjusted to use --pink */
    }
    .profile-option input[type="checkbox"] { 
      margin-right: 6px; 
      accent-color: var(--pink); /* Adjusted to use --pink */
      transform: scale(1.3);
    }
    .profile-option.selected { 
      background: color-mix(in srgb, var(--pink) 10%, white); /* Adjusted to use --pink */
      border-color: var(--pink); /* Adjusted to use --pink */
      border-width: 3px;
    }
    
    /* Reading Support: Highlight selected options more clearly */
    body.reading-support .profile-option.selected {
      background: color-mix(in srgb, var(--pink) 25%, white); /* Adjusted to use --pink */
      border-width: 4px;
    }
    
    .option-title { font-weight: 600; }
    .caption { 
      display:block; 
      font-size: 0.9rem; 
      color: var(--muted); 
      line-height: 1.4; 
    }

    .limit-note { margin-top: calc(6px * var(--spacing-base)); }

    .grid { 
      display:grid; 
      grid-template-columns: 1.2fr 1fr; 
      gap: calc(24px * var(--spacing-base)); 
      margin-top: calc(18px * var(--spacing-base)); 
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    #output {
      border: 2px solid var(--muted); 
      border-radius: var(--radius);
      padding: calc(24px * var(--spacing-base)); 
      min-height: 220px; 
      white-space: pre-wrap; 
      background: color-mix(in srgb, var(--bg) 95%, var(--muted));
      line-height: var(--line);
    }
    
    /* Reading Support: Bold key terms automatically */
    body.reading-support #output strong {
      background: linear-gradient(120deg, #fef08a 0%, #fef08a 100%);
      background-repeat: no-repeat;
      background-size: 100% 40%;
      background-position: 0 80%;
      font-weight: 800;
      color: #000;
    }
    
    /* Math Support: Add visual equation highlighting */
    body.math-support #output code,
    body.math-support #output .math {
      background: #fef3c7;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      border: 2px solid #fbbf24;
    }
    
    #output.loading::before { 
      content: "Thinking..."; 
      color: var(--muted); 
      font-style: italic; 
    }
    .error { color: var(--error); font-weight: 700; }
    .ok { color: var(--ok); font-weight: 700; }
    .warn { color: var(--warn); font-weight: 700; }

    /* Response Customization Panel */
    .response-customization {
      display: none;
      margin-top: calc(16px * var(--spacing-base));
      padding: calc(16px * var(--spacing-base));
      border: 2px solid var(--brand);
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--brand) 5%, var(--bg));
    }
    .response-customization.visible { display: block; }
    .response-customization h3 { 
      margin: 0 0 calc(12px * var(--spacing-base)) 0; 
      font-size: 1.1rem; 
      color: var(--brand); 
    }
    .customization-options { 
      display: flex; 
      flex-direction: column; 
      gap: calc(12px * var(--spacing-base)); 
    }
    .customization-row { 
      display: flex; 
      align-items: center; 
      gap: calc(12px * var(--spacing-base)); 
      flex-wrap: wrap; 
    }
    .customization-row label { 
      min-width: 140px; 
      font-weight: 600; 
    }
    .customization-row select, .customization-row input[type="range"] {
      padding: calc(6px * var(--spacing-base)) calc(10px * var(--spacing-base)); 
      border-radius: var(--radius); 
      border: 2px solid var(--muted);
      background: var(--bg); 
      color: var(--fg); 
      font-size: 1rem;
    }
    .customization-row input[type="range"] { width: 200px; }
    .customization-row .value-display { 
      min-width: 60px; 
      padding: calc(4px * var(--spacing-base)) calc(8px * var(--spacing-base)); 
      background: var(--bg); 
      border: 2px solid var(--muted); 
      border-radius: 6px; 
      font-weight: 600;
    }
    .customize-button-group { 
      display: flex; 
      gap: calc(8px * var(--spacing-base)); 
      margin-top: calc(12px * var(--spacing-base)); 
      flex-wrap: wrap;
    }
    .customize-button {
      background: var(--brand);
      color: white;
      border: none;
      padding: calc(8px * var(--spacing-base)) calc(16px * var(--spacing-base));
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .customize-button:hover { background: color-mix(in srgb, var(--brand) 90%, black); }
    .customize-button.secondary {
      background: var(--muted);
    }
    .customize-button.secondary:hover { background: color-mix(in srgb, var(--muted) 80%, black); }

    .stt-controls {
      display: flex; 
      gap: 8px; /* Used 8px from first file */
      align-items: center; 
      margin-top: 12px; /* Used 12px from first file */
      flex-wrap: wrap;
    }
    .stt-controls button {
      background: var(--ok);
    }
    .stt-controls button:hover {
      background: color-mix(in srgb, var(--ok) 90%, black);
    }
    .stt-status {
      font-size: 0.9em; 
      color: var(--muted); 
      margin-left: 10px;
    }

    /* Listening Support: Visual sound indicators */
    body.listening-support .stt-status {
      font-size: 1.1rem;
      font-weight: 700;
      padding: 8px 16px;
      background: var(--ok);
      color: white;
      border-radius: var(--radius);
    }

    .tts-controls { 
      display:flex; 
      gap:8px; /* Used 8px from first file */
      align-items:center; 
      flex-wrap: wrap; 
    }
    .tts-controls select {
      padding: 6px 10px; /* Used 6px 10px from first file */
      border-radius: var(--radius); 
      border: 2px solid var(--muted);
      background: var(--bg); 
      color: var(--fg); 
      font-size: 1rem;
    }
    .tts-rate-control { 
      display:flex; 
      gap:8px; /* Used 8px from first file */
      align-items:center; 
      padding:8px 0; /* Used 8px 0 from first file */
      flex-wrap: wrap; 
    }
    .tts-rate-control input[type="range"] { width: 120px; }

    /* Mascot-specific styles */
    .mascot-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    
    .mascot-wrapper {
      position: relative;
      width: 90px;
      height: 90px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .mascot-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
      transition: transform 0.2s ease;
      display: block;
    }
    
    .mascot-wrapper:hover .mascot-image {
      transform: scale(1.05);
    }
    
    .speech-bubble {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid var(--pink);
      border-radius: 12px;
      padding: 8px 12px;
      white-space: nowrap;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--fg);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .speech-bubble::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--pink);
    }
    
    .mascot-wrapper:hover .speech-bubble {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(18px);
    }
    
    .mascot-container h1 {
      margin: 0;
      text-align: center;
    }

    .top-banner-wrapper {
      position: relative;
      margin-bottom: 20px;
    }

    .banner-bg {
      background-color: var(--light-pink);
      width: 100vw;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      height: 150px;
      top: 0;
      z-index: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding-bottom: 10px;
      box-sizing: border-box;
      padding-left: 28px;
      padding-right: 28px;
    }

    .banner-content-aligner {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      align-items: flex-start;
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--muted);
      position: relative;
      z-index: 2;
    }
    
    .powered-by img {
      height: 34px;
      vertical-align: middle;
    }

    .wrap {
      padding-top: calc(28px + 100px); /* Adjust to make space for the banner */
    }

    .mascot-container {
      margin-top: -100px; /* Pull mascot up into the banner area */
      padding-top: 100px;
    }

    /* Progress indicator for Focus Support */
    body.focus-support .progress-indicator {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;  
      background: #e5e7eb;  
      z-index: 1000;
    }
    .progress-indicator {
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: var(--brand);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Health Support: Reduce animations and add rest reminders */
    body.health-support * {
      animation-duration: 0.1s !important;
      transition-duration: 0.1s !important;
    }
    
    .rest-reminder {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--brand);
      color: white;
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      max-width: 300px;
    }
    body.health-support .rest-reminder.visible { /* Changed to visible class for control */
      display: block;
    }
    .rest-reminder button {
      margin-top: 8px;
      background: white;
      color: var(--brand);
    }

    /* Writing Support: Word counter */
    .word-count {
      display: none;
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    body.writing-support .word-count {
      display: block;
    }

    /* Screen reader announcements */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>
  <!-- Progress indicator for Focus Support -->
  <div class="progress-indicator">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <!-- Rest reminder for Health Support -->
  <div class="rest-reminder" id="rest-reminder">
    <strong>⏰ Time for a break!</strong>
    <p>You've been studying for 25 minutes. Take a short rest.</p>
    <button onclick="dismissRestReminder()">Got it, thanks!</button>
  </div>

  <div class="top-banner-wrapper">
    <div class="banner-bg">
      <div class="banner-content-aligner">
        <div class="powered-by">
          Powered by <img src="gemini-logo.png" alt="Gemini Logo"> <img src="math-pix.jpg" alt="Math-Pix">
        </div>
      </div>
    </div>
    <div class="wrap">
      <div class="mascot-container">
        <div class="mascot-wrapper" id="mascot-wrapper">
          <img src="cougar-idle.png" alt="Mascot character" class="mascot-image" id="mascot-image">
          <div class="speech-bubble" id="speech-bubble">Whose house? COOGS HOUSE!</div>
        </div>
        <h1>Study Paws</h1>
      </div>

      <div class="file-input-container">
        <label for="file-upload">Upload Document (PDF only):</label>
        <input type="file" id="file-upload" accept=".pdf" aria-describedby="file-help" />
        <span id="file-display" aria-live="polite">No file selected</span>
        <span id="file-help" class="sr-only">Upload a PDF document to analyze</span>
      </div>

      <h2>Student Profile</h2>
      <p>Select all that apply. You can combine multiple supports.</p>

      <div class="profile-selection-container">
        <h3>Active Learning Accommodations:</h3>
        <div class="profile-options" id="profile-options" role="group" aria-label="Learning accommodations">
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Standard" checked aria-describedby="standard-desc"> 
            <div><span class="option-title">Standard Mode</span><span class="caption" id="standard-desc">For most learners. Provides balanced, readable defaults.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Reading & Language Support" aria-describedby="reading-desc">
            <div><span class="option-title">Reading & Language Support</span><span class="caption" id="reading-desc">For dyslexia and language disorders. Uses plain language and highlights key terms.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Focus & Planning Support" aria-describedby="focus-desc">
            <div><span class="option-title">Focus & Planning Support</span><span class="caption" id="focus-desc">For ADHD and executive‑function needs. Breaks work into steps with checklists and timers.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Math Understanding Support" aria-describedby="math-desc">
            <div><span class="option-title">Math Understanding Support</span><span class="caption" id="math-desc">For dyscalculia. Explains step by step and adds simple visuals.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Writing & Expression Support" aria-describedby="writing-desc">
            <div><span class="option-title">Writing & Expression Support</span><span class="caption" id="writing-desc">For dysgraphia. Reduces typing and offers structured outlines.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Listening & Hearing Support" aria-describedby="listening-desc">
            <div><span class="option-title">Listening & Hearing Support</span><span class="caption" id="listening-desc">For APD and Deaf/Hard of Hearing users. Provides captions and adjustable TTS pacing.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Vision & Screen-Reader Support" aria-describedby="vision-desc">
            <div><span class="option-title">Vision & Screen-Reader Support</span><span class="caption" id="vision-desc">For low vision and screen‑reader users. Ensures high contrast and semantic structure.</span></div>
          </label>
          <label class="profile-option">
            <input type="checkbox" name="profile" value="Health & Energy Support" aria-describedby="health-desc">
            <div><span class="option-title">Health & Energy Support</span><span class="caption" id="health-desc">For chronic illness and fatigue. Uses short sessions and lets you resume easily.</span></div>
          </label>
        </div>
        <p class="muted limit-note">Tip: You can pick multiple supports. "Standard Mode" will deselect when others are chosen.</p>
      </div>

      <div class="grid">
        <section>
          <form id="chat-form">
            <label for="prompt" class="sr-only">Enter your question about the document</label>
            <textarea id="prompt" placeholder="Ask about your document… e.g., 'Summarize Chapter 3 for Focus & Planning', or 'Create step-by-step practice for Math Understanding'." aria-label="Enter your question"></textarea>
            <div class="word-count" id="word-count" aria-live="polite">Words: 0</div>
            <div class="stt-controls">
              <button type="button" id="start-stt" aria-label="Start voice input">🎤 Start Speaking</button>
              <button type="button" id="stop-stt" disabled aria-label="Stop voice input">⏹️ Stop Speaking</button>
              <span id="stt-status" class="stt-status" role="status" aria-live="polite"></span>
            </div>
            <button type="submit" id="send-button">Send</button>
          </form>
        </section>

        <aside>
          <h2>Response</h2>
          <div class="tts-rate-control">
            <label for="rate">Speech Rate:</label>
            <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1.0" aria-label="Adjust speech rate" />
            <span id="rateVal" aria-live="polite">1.0×</span>
          </div>
          <div class="tts-controls">
            <label for="voice">Voice:</label>
            <select id="voice" aria-label="Select voice"></select>
            <button id="speak" disabled aria-label="Speak response">🔊 Speak</button>
            <button id="pause" disabled aria-label="Pause or resume">❚❚ Pause/Resume</button>
            <button id="stop" disabled aria-label="Stop speaking">■ Stop</button>
            <span class="muted">Tip: Spacebar = Play/Pause</span>
          </div>
        </aside>
      </div>

      <div id="output" aria-live="polite" aria-atomic="true" role="region" aria-label="AI Response">Awaiting your question...</div>

      <!-- Response Customization Panel -->
      <div id="response-customization" class="response-customization" role="region" aria-label="Response customization options">
        <h3>📝 Customize This Response</h3>
        <p class="muted">Adjust how the answer is presented to better fit your learning needs.</p>
        
        <div class="customization-options">
          <div class="customization-row">
            <label for="response-length">Response Length:</label>
            <select id="response-length" aria-label="Choose response length">
              <option value="shorter">Shorter (Summary)</option>
              <option value="current" selected>Current Length</option>
              <option value="longer">Longer (More Detail)</option>
            </select>
          </div>

          <div class="customization-row">
            <label for="reading-level">Reading Level:</label>
            <select id="reading-level" aria-label="Choose reading level">
              <option value="elementary">Elementary (Grade 3-5)</option>
              <option value="middle">Middle School (Grade 6-8)</option>
              <option value="high" selected>High School (Grade 9-12)</option>
              <option value="college">College Level</option>
            </select>
          </div>

          <div class="customization-row">
            <label for="detail-level">Detail Level:</label>
            <input type="range" id="detail-level" min="1" max="5" value="3" step="1" aria-label="Adjust detail level">
            <span class="value-display" id="detail-level-display" aria-live="polite">3</span>
          </div>

          <div class="customization-row">
            <label for="format-style">Format Style:</label>
            <select id="format-style" aria-label="Choose format style">
              <option value="current" selected>Keep Current Style</option>
              <option value="bullet-points">Bullet Points</option>
              <option value="numbered-steps">Numbered Steps</option>
              <option value="paragraphs">Paragraphs Only</option>
              <option value="qa">Q&A Format</option>
            </select>
          </div>

          <div class="customization-row">
            <label for="emphasis-style">Emphasis Style:</label>
            <select id="emphasis-style" aria-label="Choose emphasis style">
              <option value="current" selected>Current Style</option>
              <option value="bold-key-terms">Bold Key Terms</option>
              <option value="numbered-highlights">Numbered Highlights</option>
              <option value="minimal">Minimal Formatting</option>
            </select>
          </div>
        </div>

        <div class="customize-button-group">
          <button class="customize-button" id="apply-customization">Apply Changes</button>
          <button class="customize-button secondary" id="reset-customization">Reset to Original</button>
          <button class="customize-button secondary" id="hide-customization">Hide Panel</button>
        </div>
      </div>

      <audio id="audio-playback" hidden></audio>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let file = null;
    let originalResponse = '';
    let currentContext = ''; // From second file, for potential future use if backend changes
    let currentUserPrompt = '';
    let studyStartTime = null; // From first file
    let restReminderTimeout = null; // From first file
    let restReminderInterval; // From second file, for repeated checks

    const chatForm = $("chat-form");
    const promptInput = $("prompt");
    const output = $("output");
    const sendButton = $("send-button");
    const fileUpload = $("file-upload");
    const fileDisplay = $("file-display");
    const rate = $("rate");
    const rateVal = $("rateVal");
    const profileOptionsContainer = $("profile-options");
    const wordCountDisplay = $("word-count"); // Renamed from wordCount for consistency
    const progressBar = $("progress-bar");
    const restReminder = $("rest-reminder"); // Added from first file

    // Mascot elements
    const mascotWrapper = $("mascot-wrapper");
    const mascotImage = $("mascot-image");
    const speechBubble = $("speech-bubble");

    // Response customization elements
    const responseCustomization = $("response-customization");
    const responseLength = $("response-length");
    const readingLevel = $("reading-level");
    const detailLevel = $("detail-level");
    const detailLevelDisplay = $("detail-level-display");
    const formatStyle = $("format-style");
    const emphasisStyle = $("emphasis-style");
    const applyCustomization = $("apply-customization");
    const resetCustomization = $("reset-customization");
    const hideCustomization = $("hide-customization");

    // Mascot configuration
    const mascots = {
      cougar: { idle: "cougar-idle.png", animated: "cougar-gif.avif", message: "Whose house? COOGS HOUSE!" },
      cow: { idle: "cow-idle.png", animated: "cow-gif.gif", message: "I'm mooing for you!" },
      owl: { idle: "owl-idle.png", animated: "owl-gif.gif", message: "I'm hooting for you!" },
      cat: { idle: "cat-idle.png", animated: "cat-gif.gif", message: "I'm meowing for you!" }
    };

    const mascotOrder = ["cougar", "cow", "owl", "cat"];
    let currentMascotIndex = 0;
    let isHovering = false;
    let animationTimeout = null;

    function getCurrentMascot() {
      return mascots[mascotOrder[currentMascotIndex]];
    }

    // Mascot click handler
    mascotWrapper.addEventListener('click', () => {
      currentMascotIndex = (currentMascotIndex + 1) % mascotOrder.length;
      const mascot = getCurrentMascot();
      mascotImage.src = mascot.idle;
      mascotImage.alt = `${mascotOrder[currentMascotIndex]} mascot`;
      speechBubble.textContent = mascot.message;
    });

    // Mascot hover handlers
    mascotWrapper.addEventListener('mouseenter', () => {
      isHovering = true;
      const mascot = getCurrentMascot();
      speechBubble.textContent = mascot.message;
      animationTimeout = setTimeout(() => {
        if (isHovering) mascotImage.src = mascot.animated;
      }, 300);
    });

    mascotWrapper.addEventListener('mouseleave', () => {
      isHovering = false;
      clearTimeout(animationTimeout);
      mascotImage.src = getCurrentMascot().idle;
    });

    // ElevenLabs TTS elements
    const voiceSelect = $("voice");
    const elevenLabsAudio = $("audio-playback");
    
    // STT elements
    const startSttButton = $("start-stt");
    const stopSttButton = $("stop-stt");
    const sttStatus = $("stt-status");

    // ElevenLabs backend URLs
    const BACKEND_URL_VOICES = "/voices";
    const BACKEND_URL_TTS = "/tts";

    let recognition;
    let isRecognizing = false;

    // Load saved rate
    const savedRate = localStorage.getItem('tts_rate');
    if (savedRate) { 
      rate.value = savedRate; 
      rateVal.textContent = `${parseFloat(savedRate).toFixed(2)}×`; 
    }

    // Detail level display update
    detailLevel.addEventListener('input', () => {
      detailLevelDisplay.textContent = detailLevel.value;
    });

    // Word counter for writing support
    promptInput.addEventListener('input', () => {
      const words = promptInput.value.trim().split(/\s+/).filter(w => w.length > 0).length;
      wordCountDisplay.textContent = `Words: ${words}`;
      updateProgressBar(); // Update progress bar when typing
    });

    // --- Accessibility Mode Application (Combined and Enhanced) ---
    function updateAccessibilityClasses() { // Renamed from applyAccessibilityModes
      const profiles = getSelectedProfiles();
      document.body.classList.remove('reading-support', 'vision-support', 'focus-support', 'math-support', 'writing-support', 'listening-support', 'health-support');
      
      profiles.forEach(profile => {
        if (profile.includes('Reading')) {
          document.body.classList.add('reading-support');
          announceToScreenReader('Reading and language support activated. Using larger fonts and dyslexia-friendly spacing.');
        }
        if (profile.includes('Vision')) {
          document.body.classList.add('vision-support');
          announceToScreenReader('Vision support activated. Using high contrast and larger text.');
        }
        if (profile.includes('Focus')) {
          document.body.classList.add('focus-support');
          announceToScreenReader('Focus and planning support activated. Sections are numbered for easier navigation.');
          updateProgressBar(); // Ensure progress bar is updated
        }
        if (profile.includes('Math')) {
          document.body.classList.add('math-support');
          announceToScreenReader('Math understanding support activated. Mathematical expressions will be highlighted.');
        }
        if (profile.includes('Writing')) {
          document.body.classList.add('writing-support');
          announceToScreenReader('Writing and expression support activated. Larger text input and word counter enabled.');
        }
        if (profile.includes('Listening')) {
          document.body.classList.add('listening-support');
          announceToScreenReader('Listening and hearing support activated. Enhanced visual feedback for audio controls.');
        }
        if (profile.includes('Health')) {
          document.body.classList.add('health-support');
          announceToScreenReader('Health and energy support activated. Rest reminders enabled.');
          startRestTimer(); // From first file, start timer when health support is enabled
        }
      });

      if (!profiles.includes('Health & Energy Support')) {
          stopRestTimer(); // Stop timer if health support is not selected
      }
    }

    function announceToScreenReader(message) {
      const announcement = document.createElement('div');
      announcement.className = 'sr-only';
      announcement.setAttribute('role', 'status');
      announcement.setAttribute('aria-live', 'polite');
      announcement.textContent = message;
      document.body.appendChild(announcement);
      setTimeout(() => announcement.remove(), 1000);
    }

    function updateProgressBar() {
      // Calculate progress based on form completion
      let progress = 0;
      if (file) progress += 33;
      if (promptInput.value.trim()) progress += 33;
      if (output.textContent !== 'Awaiting your question...') progress += 34;
      progressBar.style.width = progress + '%';
    }

    // Rest timer for health support (Combined functionality from both files)
    function startRestTimer() {
      stopRestTimer(); // Clear any existing
      studyStartTime = Date.now();
      restReminderTimeout = setTimeout(() => {
        restReminder.classList.add('visible');
        announceToScreenReader('Time for a break! You have been studying for 25 minutes.');
      }, 25 * 60 * 1000); // 25 minutes from first file
    }

    function stopRestTimer() {
      if (restReminderTimeout) {
        clearTimeout(restReminderTimeout);
        restReminderTimeout = null;
      }
    }

    window.dismissRestReminder = function() {
      restReminder.classList.remove('visible');
      startRestTimer(); // Restart timer
      announceToScreenReader('Break reminder dismissed. Timer reset.');
    }

    // Profile Selection Logic
    function getSelectedProfiles() {
      const sel = Array.from(profileOptionsContainer.querySelectorAll('input[name="profile"]:checked')).map(cb => cb.value);
      if (sel.includes('Standard') && sel.length > 1) return sel.filter(x => x !== 'Standard');
      return sel.length ? sel : ['Standard'];
    }

    profileOptionsContainer.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.name === 'profile') {
        const standardCb = profileOptionsContainer.querySelector('input[name="profile"][value="Standard"]');
        const checked = Array.from(profileOptionsContainer.querySelectorAll('input[name="profile"]:checked'));
        const othersChecked = checked.some(cb => cb.value !== 'Standard');
        
        if (standardCb && standardCb.checked && othersChecked) {
          standardCb.checked = false;
        }
        
        const stillChecked = profileOptionsContainer.querySelectorAll('input[name="profile"]:checked');
        if (stillChecked.length === 0 && standardCb) {
          standardCb.checked = true;
        }
        
        profileOptionsContainer.querySelectorAll('label.profile-option').forEach(l => 
          l.classList.toggle('selected', l.querySelector('input').checked)
        );
        
        updateAccessibilityClasses(); // Call the combined update function
      }
    });

    profileOptionsContainer.querySelectorAll('label.profile-option').forEach(l => 
      l.classList.toggle('selected', l.querySelector('input').checked)
    );

    // File Upload
    fileUpload.addEventListener('change', (e) => {
      file = e.target.files[0];
      fileDisplay.textContent = file ? `File: ${file.name}` : 'No file selected';
      updateProgressBar();
      if (file) {
        announceToScreenReader(`File selected: ${file.name}`);
      }
    });

    // Chat Form Submission
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userPrompt = promptInput.value.trim();
      const selectedProfiles = getSelectedProfiles();

      if (!userPrompt) { 
        output.innerHTML = '<span class="warn">Please enter a question.</span>'; 
        announceToScreenReader('Error: Please enter a question.');
        return; 
      }
      if (!file) { 
        output.innerHTML = '<span class="warn">Please upload a PDF document first.</span>'; 
        announceToScreenReader('Error: Please upload a PDF document first.');
        return; 
      }

      // Store current prompt for customization
      currentUserPrompt = userPrompt;

      // Hide customization panel for new query
      responseCustomization.classList.remove('visible');

      // Disable TTS until we have content
      [$("speak"), $("pause"), $("stop")].forEach(b => b.disabled = true);
      elevenLabsAudio.pause();
      elevenLabsAudio.currentTime = 0;
      
      output.innerHTML = '';
      output.classList.add('loading');
      sendButton.disabled = true; 
      sendButton.textContent = 'Processing…';
      announceToScreenReader('Processing your question. Please wait.');

      try {
        progressBar.style.width = '30%'; // Start progress bar

        const formData = new FormData();
        formData.append('prompt', userPrompt);
        selectedProfiles.forEach(p => formData.append('profile_types', p));
        formData.append('file', file);

        const response = await fetch('/chat', { method: 'POST', body: formData });
        
        progressBar.style.width = '60%'; // Update progress

        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const data = await response.json();

        if (data.error) {
          output.innerHTML = `<span class="error">Error: ${data.error}</span>`;
          announceToScreenReader(`Error: ${data.error}`);
        } else {
          const markdownText = data.response || '';
          originalResponse = markdownText;
          currentContext = data.document_context || ''; // Keep for potential future use
          
          displayResponse(markdownText);
          announceToScreenReader('Response received. You can now customize it or have it read aloud.');

          // Show customization panel
          responseCustomization.classList.add('visible');

          // Enable TTS and auto-speak
          [$("speak"), $("pause"), $("stop")].forEach(b => b.disabled = false);
          speakElevenLabs(stripMarkdown(markdownText));
          
          updateProgressBar(); // Final progress update
        }
        
        progressBar.style.width = '100%';
        setTimeout(() => { progressBar.style.width = '0%'; }, 500); // Reset progress bar
        
      } catch (err) {
        console.error(err);
        output.innerHTML = `<span class="error">An unexpected error occurred: ${err.message}</span>`;
        announceToScreenReader(`Error: ${err.message}`);
        progressBar.style.width = '0%'; // Reset progress on error
      } finally {
        output.classList.remove('loading');
        sendButton.disabled = false; 
        sendButton.textContent = 'Send';
      }
    });

    function displayResponse(markdownText) {
      const htmlContent = markdownText
        .replace(/^# (.*)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*)$/gm, '<h4>$1</h4>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^\* (.*)$/gm, '<ul><li>$1</li></ul>')
        .replace(/`/g, '');
      output.innerHTML = htmlContent || '<span class="muted">No content returned.</span>';
    }

    // --- Response Customization Logic ---
    applyCustomization.addEventListener('click', async () => {
      const customizationSettings = {
        length: responseLength.value,
        reading_level: readingLevel.value,
        detail_level: parseInt(detailLevel.value),
        format_style: formatStyle.value,
        emphasis_style: emphasisStyle.value
      };

      // Build customization instruction
      let customInstruction = "Adjust the previous response with these changes:\n";
      
      if (customizationSettings.length === 'shorter') {
        customInstruction += "- Make it significantly shorter, focus on key points only\n";
      } else if (customizationSettings.length === 'longer') {
        customInstruction += "- Expand with more detail, examples, and explanations\n";
      }

      const levelMap = {
        'elementary': 'elementary school (grades 3-5)',
        'middle': 'middle school (grades 6-8)',
        'high': 'high school (grades 9-12)',
        'college': 'college level'
      };
      customInstruction += `- Use ${levelMap[customizationSettings.reading_level]} reading level\n`;
      
      customInstruction += `- Detail level: ${customizationSettings.detail_level}/5\n`;

      if (customizationSettings.format_style !== 'current') {
        const formatMap = {
          'bullet-points': 'bullet points with clear separation',
          'numbered-steps': 'numbered step-by-step format',
          'paragraphs': 'flowing paragraphs without lists',
          'qa': 'question and answer format'
        };
        customInstruction += `- Format: ${formatMap[customizationSettings.format_style]}\n`;
      }

      if (customizationSettings.emphasis_style !== 'current') {
        const emphasisMap = {
          'bold-key-terms': 'bold all key terms and important concepts',
          'numbered-highlights': 'number and highlight main points',
          'minimal': 'use minimal formatting, keep it clean'
        };
        customInstruction += `- Emphasis: ${emphasisMap[customizationSettings.emphasis_style]}\n`;
      }

      const selectedProfiles = getSelectedProfiles();
      customInstruction += `\nOriginal question: ${currentUserPrompt}\n\nOriginal response:\n${originalResponse}`;

      // Show loading state
      output.classList.add('loading');
      applyCustomization.disabled = true;
      applyCustomization.textContent = 'Applying...';
      announceToScreenReader('Applying customization changes. Please wait.');

      try {
        const formData = new FormData();
        formData.append('prompt', customInstruction);
        selectedProfiles.forEach(p => formData.append('profile_types', p));
        formData.append('file', file);
        formData.append('is_customization', 'true');

        const response = await fetch('/chat', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const data = await response.json();

        if (data.error) {
          output.innerHTML = `<span class="error">Error: ${data.error}</span>`;
          announceToScreenReader(`Error: ${data.error}`);
        } else {
          const markdownText = data.response || '';
          displayResponse(markdownText);
          announceToScreenReader('Response customized successfully.');

          // Update TTS
          elevenLabsAudio.pause();
          speakElevenLabs(stripMarkdown(markdownText));
        }
      } catch (err) {
        console.error(err);
        output.innerHTML = `<span class="error">Customization failed: ${err.message}</span>`;
        announceToScreenReader(`Customization failed: ${err.message}`);
      } finally {
        output.classList.remove('loading');
        applyCustomization.disabled = false;
        applyCustomization.textContent = 'Apply Changes';
      }
    });

    resetCustomization.addEventListener('click', () => {
      displayResponse(originalResponse);
      announceToScreenReader('Response reset to original.');
      
      // Reset all controls
      responseLength.value = 'current';
      readingLevel.value = 'high';
      detailLevel.value = '3';
      detailLevelDisplay.textContent = '3';
      formatStyle.value = 'current';
      emphasisStyle.value = 'current';

      // Update TTS
      elevenLabsAudio.pause();
      speakElevenLabs(stripMarkdown(originalResponse));
    });

    hideCustomization.addEventListener('click', () => {
      responseCustomization.classList.remove('visible');
      announceToScreenReader('Customization panel hidden.');
    });

    function stripMarkdown(md) {
      return md
        .replace(/^# .*$/gm, '')
        .replace(/^## .*$/gm, '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/^\* |^- /gm, '• ')
        .replace(/`{1,3}([^`]+)`{1,3}/g, '$1');
    }

    // --- ElevenLabs TTS ---
    async function loadVoices() {
      try {
        const res = await fetch(BACKEND_URL_VOICES);
        const voices = await res.json();
        voiceSelect.innerHTML = '';
        voices.forEach(v => {
          const option = document.createElement("option");
          option.value = v;
          option.text = v;
          voiceSelect.add(option);
        });
        
        if (voices.length > 0) {
          const savedVoice = localStorage.getItem('elevenlabs_voice');
          if (savedVoice && voices.includes(savedVoice)) {
            voiceSelect.value = savedVoice;
          } else {
            voiceSelect.value = voices[0];
          }
        }
      } catch (err) {
        console.error("Failed to load ElevenLabs voices", err);
        const option = document.createElement("option");
        option.value = "default";
        option.text = "Error loading voices";
        voiceSelect.add(option);
        voiceSelect.disabled = true;
      }
    }

    async function speakElevenLabs(text) {
      if (!text.trim()) return;

      const voice = voiceSelect.value;
      const rateValue = parseFloat(rate.value);

      try {
        const res = await fetch(BACKEND_URL_TTS, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ text, voice, rate: rateValue })
        });

        if (!res.ok) throw new Error("ElevenLabs TTS request failed");

        const blob = await res.blob();
        const audioURL = URL.createObjectURL(blob);

        elevenLabsAudio.src = audioURL;
        elevenLabsAudio.playbackRate = rateValue;
        elevenLabsAudio.play();
        announceToScreenReader('Audio playback started.');
      } catch (err) {
      }
    }

    $("speak").addEventListener('click', () => {
      const textToSpeak = stripMarkdown(output.textContent);
      if (textToSpeak) {
        elevenLabsAudio.pause();
        speakElevenLabs(textToSpeak);
      }
    });

    $("pause").addEventListener('click', () => {
      if (elevenLabsAudio.paused) {
        elevenLabsAudio.play();
        announceToScreenReader('Audio resumed.');
      } else {
        elevenLabsAudio.pause();
        announceToScreenReader('Audio paused.');
      }
    });

    $("stop").addEventListener('click', () => {
      elevenLabsAudio.pause();
      elevenLabsAudio.currentTime = 0;
      announceToScreenReader('Audio stopped.');
    });

    rate.addEventListener('input', () => {
      rateVal.textContent = `${parseFloat(rate.value).toFixed(2)}×`;
      localStorage.setItem('tts_rate', rate.value);
      elevenLabsAudio.playbackRate = parseFloat(rate.value);
    });

    voiceSelect.addEventListener('change', () => {
      localStorage.setItem('elevenlabs_voice', voiceSelect.value);
    });

    // --- Speech to Text (Web Speech API) ---
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        isRecognizing = true;
        sttStatus.textContent = 'Listening...';
        startSttButton.disabled = true;
        stopSttButton.disabled = false;
        announceToScreenReader('Voice input started. Begin speaking.');
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + ' ';
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        
        if (finalTranscript) {
          const currentText = promptInput.value.trim();
          promptInput.value = currentText ? currentText + ' ' + finalTranscript.trim() : finalTranscript.trim();
          wordCountDisplay.dispatchEvent(new Event('input')); // Trigger word count update
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        
        if (event.error === 'no-speech') {
          sttStatus.textContent = 'Listening... (no speech detected)';
          return;
        }
        
        sttStatus.innerHTML = `<span class="error">STT Error: ${event.error}</span>`;
        announceToScreenReader(`Speech recognition error: ${event.error}`);
        isRecognizing = false;
        startSttButton.disabled = false;
        stopSttButton.disabled = true;
      };

      recognition.onend = () => {
        if (isRecognizing) {
          try {
            recognition.start();
          } catch (e) {
            console.log('Recognition restart failed:', e);
            isRecognizing = false;
            sttStatus.textContent = 'Stopped listening.';
            startSttButton.disabled = false;
            stopSttButton.disabled = true;
          }
        } else {
          sttStatus.textContent = 'Stopped listening.';
          startSttButton.disabled = false;
          stopSttButton.disabled = true;
          announceToScreenReader('Voice input stopped.');
        }
      };

      startSttButton.addEventListener('click', () => {
        if (isRecognizing) {
          recognition.stop();
          return;
        }
        isRecognizing = true;
        recognition.start();
      });

      stopSttButton.addEventListener('click', () => {
        isRecognizing = false;
        recognition.stop();
      });

    } else {
      startSttButton.disabled = true;
      stopSttButton.disabled = true;
      sttStatus.innerHTML = '<span class="warn">Speech recognition not supported in this browser.</span>';
    }

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
      if (e.key === ' ' && document.activeElement !== promptInput) { 
        e.preventDefault(); 
        const speakBtn = $("speak"); 
        if (!speakBtn.disabled) { 
          if (elevenLabsAudio.paused) {
            elevenLabsAudio.play();
          } else {
            elevenLabsAudio.pause();
          }
        }
      }
      if (e.key === 'Escape') { 
        e.preventDefault(); 
        $("stop").click(); 
      }
      if (e.key === 'Enter' && !e.shiftKey && promptInput === document.activeElement) { 
        e.preventDefault(); 
        $("send-button").click(); 
      }
    });

    // Initial load
    loadVoices();
    updateAccessibilityClasses(); // Initial call to set modes
  </script>
</body>
</html>
